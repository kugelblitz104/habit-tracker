version: '3.8'

services:
    postgres:
        image: postgres:16-alpine
        container_name: habit_tracker_db
        environment:
            POSTGRES_USER: habit_tracker
            POSTGRES_PASSWORD: dev_password
            POSTGRES_DB: habit_tracker_dev
        ports:
            - '5432:5432'
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'pg_isready -U habit_tracker -d habit_tracker_dev'
                ]
            interval: 10s
            timeout: 5s
            retries: 5

    api:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: habit_tracker_api
        environment:
            DATABASE_URL: postgresql://habit_tracker:dev_password@postgres:5432/habit_tracker_dev
        ports:
            - '8080:8080'
        depends_on:
            postgres:
                condition: service_healthy
        volumes:
            - ./src:/code/src
        command:
            [
                'uv',
                'run',
                'uvicorn',
                'habit_tracker.main:app',
                '--host',
                '0.0.0.0',
                '--port',
                '8080',
                '--reload'
            ]

volumes:
    postgres_data:
